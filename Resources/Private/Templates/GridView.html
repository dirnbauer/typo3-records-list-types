<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
      xmlns:core="http://typo3.org/ns/TYPO3/CMS/Core/ViewHelpers"
      xmlns:be="http://typo3.org/ns/TYPO3/CMS/Backend/ViewHelpers"
      data-namespace-typo3-fluid="true">

<div class="recordlist-gridview-container">

    <f:comment>WCAG 2.1: Screen reader live region for drag and drop announcements</f:comment>
    <div id="gridview-live-region" 
         class="visually-hidden" 
         aria-live="polite" 
         aria-atomic="true"
         role="status"></div>

    <f:comment>WCAG 2.1: Hidden instructions for keyboard drag and drop</f:comment>
    <div id="gridview-drag-instructions" class="visually-hidden">
        <f:translate key="LLL:EXT:records_list_types/Resources/Private/Language/locallang.xlf:drag.instructions" 
                     default="Press Space or Enter to grab item. Use arrow keys to move. Press Space or Enter to drop, Escape to cancel." />
    </div>

    <f:comment>Middleware Warning (if applicable)</f:comment>
    <f:if condition="{middlewareWarning}">
        <div class="callout callout-warning">
            <div class="callout-body">
                <core:icon identifier="actions-exclamation-triangle" size="small" />
                <span class="ms-2">{middlewareWarning}</span>
                <a href="{forceListViewUrl}" class="btn btn-sm btn-default ms-2">Force List View</a>
            </div>
        </div>
    </f:if>

    <f:comment>Render each table's records using native TYPO3 recordlist styling</f:comment>
    <f:if condition="{tableData}">
        <f:then>
            <f:for each="{tableData}" as="table">
                <div class="recordlist" id="t3-table-{table.tableName}">
                    <f:comment>Table header - matches native List View styling exactly</f:comment>
                    <div class="recordlist-heading">
                        <div class="recordlist-heading-row">
                            <f:comment>Title section with table name link - identical to core</f:comment>
                            <div class="recordlist-heading-title">
                                <f:if condition="{currentTable}">
                                    <f:then>
                                        <f:comment>In single table mode - link back to all tables</f:comment>
                                        <a href="{table.clearTableUrl}">
                                            <span class="fw-bold">{table.tableLabel}</span>
                                            <span>({table.recordCount})</span>
                                            <span class="ms-1"><core:icon identifier="actions-view-table-collapse" size="small" /></span>
                                        </a>
                                    </f:then>
                                    <f:else>
                                        <f:comment>In multi-table mode - link to single table view</f:comment>
                                        <a href="{table.singleTableUrl}">
                                            <span class="fw-bold">{table.tableLabel}</span>
                                            <span>({table.recordCount})</span>
                                            <span class="ms-1"><core:icon identifier="actions-view-table-expand" size="small" /></span>
                                        </a>
                                    </f:else>
                                </f:if>
                            </div>

                            <f:comment>Actions section - matches core structure exactly</f:comment>
                            <div class="recordlist-heading-actions">
                                <f:comment>Sorting controls: mode toggle + sorting dropdown (integrated)</f:comment>
                                <f:if condition="{table.sortingModeToggleHtml}">
                                    <f:format.raw>{table.sortingModeToggleHtml}</f:format.raw>
                                </f:if>

                                <f:comment>New record button</f:comment>
                                <f:if condition="{table.actionButtons.newRecordButton}">
                                    <f:format.raw>{table.actionButtons.newRecordButton}</f:format.raw>
                                </f:if>
                                
                                <f:comment>Download/Export button</f:comment>
                                <f:if condition="{table.actionButtons.downloadButton}">
                                    <f:format.raw>{table.actionButtons.downloadButton}</f:format.raw>
                                </f:if>
                                
                                <f:comment>Column selector button (web component)</f:comment>
                                <f:if condition="{table.actionButtons.columnSelectorButton}">
                                    <f:format.raw>{table.actionButtons.columnSelectorButton}</f:format.raw>
                                </f:if>

                                <f:comment>Collapse/Expand button</f:comment>
                                <f:if condition="{table.actionButtons.collapseButton}">
                                    <f:format.raw>{table.actionButtons.collapseButton}</f:format.raw>
                                </f:if>
                            </div>
                        </div>
                    </div>

                    <f:comment>Grid content - with WCAG 2.1 ARIA attributes for drag and drop</f:comment>
                    <div class="collapse show" data-state="expanded" id="recordlist-{table.tableName}">
                        <div class="gridview-card-grid"
                             data-table="{table.tableName}"
                             data-can-reorder="{f:if(condition: table.canReorder, then: '1', else: '0')}"
                             data-last-uid="{table.lastRecordUid}"
                             {f:if(condition: table.canReorder, then: 'role="listbox" aria-label="{table.tableLabel} - reorderable list" aria-describedby="gridview-drag-instructions"')}>
                            <f:for each="{table.records}" as="record" iteration="iterator">
                                <div class="gridview-card-wrapper"
                                     data-index="{iterator.index}">
                                    <f:render partial="Card" arguments="{record: record, tableConfig: table.tableConfig, tableName: table.tableName, displayColumns: table.displayColumns, canReorder: table.canReorder}" />
                                </div>
                            </f:for>
                            <f:comment>End dropzone - visible during drag to allow dropping after last item</f:comment>
                            <f:if condition="{table.canReorder}">
                                <div class="gridview-end-dropzone"
                                     data-table="{table.tableName}"
                                     data-last-uid="{table.lastRecordUid}"
                                     aria-hidden="true">
                                    <span class="gridview-end-dropzone__label">
                                        <f:translate key="LLL:EXT:records_list_types/Resources/Private/Language/locallang.xlf:drag.dropHere" default="Drop here" />
                                    </span>
                                </div>
                            </f:if>
                        </div>
                    </div>
                </div>
            </f:for>
        </f:then>
        <f:else>
            <div class="callout callout-info">
                <div class="callout-body">
                    <core:icon identifier="actions-info" size="small" />
                    <span class="ms-2">No records found on this page.</span>
                </div>
            </div>
        </f:else>
    </f:if>

</div>

</html>
